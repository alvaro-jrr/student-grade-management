// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "mysql"
    url      = env("DATABASE_URL")
}

// Modulo
model Module {
    id         Int         @id @default(autoincrement())
    name       String      @db.VarChar(25)
    operations Operation[]
}

// Nombre de Operacion
enum OperationName {
    CREATE
    READ
    UPDATE
    DELETE
}

// Operacion
model Operation {
    id       Int               @id @default(autoincrement())
    name     OperationName
    module   Module            @relation(fields: [moduleId], references: [id])
    moduleId Int
    roles    OperationByRole[]
}

// Nombre de Rol
enum RoleName {
    ADMIN
    COORDINATOR
    TEACHER
    REPRESENTATIVE
    STUDENT
}

// Rol
model Role {
    id         Int               @id @default(autoincrement())
    name       RoleName          @unique
    users      User[]
    operations OperationByRole[]
}

// Operacion por Rol
model OperationByRole {
    id          Int       @id @default(autoincrement())
    operation   Operation @relation(fields: [operationId], references: [id])
    operationId Int
    role        Role      @relation(fields: [roleId], references: [id])
    roleId      Int
}

// Persona
model Person {
    identityCard   String          @id
    createdAt      DateTime        @default(now())
    updatedAt      DateTime        @updatedAt
    firstname      String          @db.VarChar(25)
    lastname       String          @db.VarChar(25)
    representative Representative?
    coordinator    Coordinator?
    teacher        Teacher?
    student        Student?
    role           RoleName
}

// Representative
model Representative {
    identityCard String                    @id
    email        String                    @unique
    person       Person                    @relation(fields: [identityCard], references: [identityCard], onDelete: Cascade)
    phones       Phone[]
    students     RepresentativeByStudent[]
}

// Coordinador
model Coordinator {
    identityCard   String    @id
    person         Person    @relation(fields: [identityCard], references: [identityCard], onDelete: Cascade)
    entryDate      DateTime  @default(now())
    retirementDate DateTime?
    isActive       Boolean   @default(true)
}

// Docente
model Teacher {
    identityCard  String         @id
    person        Person         @relation(fields: [identityCard], references: [identityCard], onDelete: Cascade)
    academicLoads AcademicLoad[]
}

// Estudiante
model Student {
    identityCard    String                    @id
    person          Person                    @relation(fields: [identityCard], references: [identityCard], onDelete: Cascade)
    birthDate       DateTime
    grades          Grade[]
    representatives RepresentativeByStudent[]
    enrollments     Enrollment[]
    sections        StudentBySection[]
}

// Usuario
model User {
    id           Int      @id @default(autoincrement())
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt
    identityCard String   @unique
    username     String   @unique
    password     String
    role         Role     @relation(fields: [roleId], references: [id])
    roleId       Int
}

// Telefono
model Phone {
    id                         Int            @id @default(autoincrement())
    createdAt                  DateTime       @default(now())
    updatedAt                  DateTime       @updatedAt
    representative             Representative @relation(fields: [representativeIdentityCard], references: [identityCard])
    representativeIdentityCard String
    phoneNumber                String
}

// Representante
model RepresentativeByStudent {
    id                         Int            @id @default(autoincrement())
    createdAt                  DateTime       @default(now())
    representative             Representative @relation(fields: [representativeIdentityCard], references: [identityCard], onDelete: Cascade)
    representativeIdentityCard String
    student                    Student        @relation(fields: [studentIdentityCard], references: [identityCard])
    studentIdentityCard        String
}

// Periodo Academico
model AcademicPeriod {
    id            Int                         @id @default(autoincrement())
    createdAt     DateTime                    @default(now())
    updatedAt     DateTime                    @updatedAt
    startDate     DateTime
    endDate       DateTime
    academicLoads AcademicLoad[]
    studyYears    StudyYearByAcademicPeriod[]
}

// Año de Estudio
model StudyYear {
    id              Int                         @id @default(autoincrement())
    year            Int                         @db.UnsignedInt
    academicPeriods StudyYearByAcademicPeriod[]
    courses         Course[]
}

// Año de Estudio por Periodo Academico
model StudyYearByAcademicPeriod {
    id               Int            @id @default(autoincrement())
    createdAt        DateTime       @default(now())
    academicPeriod   AcademicPeriod @relation(fields: [academicPeriodId], references: [id])
    academicPeriodId Int
    studyYear        StudyYear      @relation(fields: [studyYearId], references: [id])
    studyYearId      Int
    enrollments      Enrollment[]
    sections         Section[]

    @@unique([academicPeriodId, studyYearId])
}

// Curso
model Course {
    id            Int            @id @default(autoincrement())
    createdAt     DateTime       @default(now())
    updatedAt     DateTime       @updatedAt
    studyYear     StudyYear      @relation(fields: [studyYearId], references: [id])
    studyYearId   Int
    title         String
    academicLoads AcademicLoad[]

    @@unique([studyYearId, title])
}

// Lapso
model Lapse {
    id          Int     @id @default(autoincrement())
    description Int     @db.UnsignedInt
    grades      Grade[]
}

// Carga Academica
model AcademicLoad {
    id                 Int            @id @default(autoincrement())
    createdAt          DateTime       @default(now())
    updatedAt          DateTime       @updatedAt
    academicPeriod     AcademicPeriod @relation(fields: [academicPeriodId], references: [id])
    academicPeriodId   Int
    teacher            Teacher        @relation(fields: [teacherIdentiyCard], references: [identityCard])
    teacherIdentiyCard String
    course             Course         @relation(fields: [courseId], references: [id])
    courseId           Int
    assignments        Assignment[]

    @@unique([academicPeriodId, teacherIdentiyCard, courseId])
}

// Evaluacion
model Assignment {
    id             Int          @id @default(autoincrement())
    createdAt      DateTime     @default(now())
    updatedAt      DateTime     @updatedAt
    academicLoad   AcademicLoad @relation(fields: [academicLoadId], references: [id])
    academicLoadId Int
    description    String
    weight         Int          @db.UnsignedInt
    grades         Grade[]
}

// Calificacion
model Grade {
    id                  Int        @id @default(autoincrement())
    createdAt           DateTime   @default(now())
    updatedAt           DateTime   @updatedAt
    lapse               Lapse      @relation(fields: [lapseId], references: [id])
    lapseId             Int
    student             Student    @relation(fields: [studentIdentityCard], references: [identityCard])
    studentIdentityCard String
    assignment          Assignment @relation(fields: [assignmentId], references: [id])
    assignmentId        Int
    score               Float
    note                String

    @@unique([lapseId, studentIdentityCard, assignmentId])
}

// Inscripcion
model Enrollment {
    id                          Int                       @id @default(autoincrement())
    createdAt                   DateTime                  @default(now())
    student                     Student                   @relation(fields: [studentIdentityCard], references: [identityCard])
    studentIdentityCard         String
    studyYearByAcademicPeriod   StudyYearByAcademicPeriod @relation(fields: [studyYearByAcademicPeriodId], references: [id])
    studyYearByAcademicPeriodId Int

    @@unique([studentIdentityCard, studyYearByAcademicPeriodId])
}

// Seccion
model Section {
    id                          Int                       @id @default(autoincrement())
    createdAt                   DateTime                  @default(now())
    updatedAt                   DateTime                  @updatedAt
    studyYearByAcademicPeriod   StudyYearByAcademicPeriod @relation(fields: [studyYearByAcademicPeriodId], references: [id])
    studyYearByAcademicPeriodId Int
    description                 String                    @db.Char(1)
    students                    StudentBySection[]
}

// Estudiante por Seccion
model StudentBySection {
    id                  Int      @id @default(autoincrement())
    createdAt           DateTime @default(now())
    section             Section  @relation(fields: [sectionId], references: [id])
    sectionId           Int
    student             Student  @relation(fields: [studentIdentityCard], references: [identityCard])
    studentIdentityCard String

    @@unique([studentIdentityCard, sectionId])
}
